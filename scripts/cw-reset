#!/bin/bash
#
# cw-reset - Reset failed or stuck tasks
#
# Resets task statuses directly in ~/.claude/tasks files.
# No Claude invocation needed — operates on task JSON files directly.
#
# Usage:
#   ./cw-reset [OPTIONS] [TASK_IDS...]
#
# Options:
#   -a, --all-failed      Reset all failed tasks to pending
#   -s, --stuck           Reset in_progress tasks (likely abandoned)
#   -h, --help            Show this help
#
# Examples:
#   ./cw-reset T01 T03          Reset specific tasks
#   ./cw-reset --all-failed     Reset all failed tasks
#   ./cw-reset --stuck          Reset abandoned in_progress tasks
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cw-common.sh"

# =============================================================================
# Argument Parsing
# =============================================================================

RESET_ALL_FAILED=false
RESET_STUCK=false
TASK_IDS=()
PROJECT_PATH=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -a|--all-failed) RESET_ALL_FAILED=true; shift ;;
        -s|--stuck) RESET_STUCK=true; shift ;;
        -h|--help)
            echo "Usage: cw-reset [OPTIONS] [TASK_IDS...]"
            echo ""
            echo "Reset failed or stuck tasks to pending status."
            echo "Operates directly on task files — no Claude invocation needed."
            echo ""
            echo "Options:"
            echo "  -a, --all-failed    Reset all failed tasks"
            echo "  -s, --stuck         Reset in_progress (abandoned) tasks"
            echo "  -h, --help          Show this help"
            echo ""
            echo "Examples:"
            echo "  cw-reset T01 T03"
            echo "  cw-reset --all-failed"
            echo "  cw-reset --stuck"
            exit 0
            ;;
        -*) log_error "Unknown option: $1"; exit 1 ;;
        *) TASK_IDS+=("$1"); shift ;;
    esac
done

# =============================================================================
# Validation
# =============================================================================

check_jq || exit 1

if [ "$RESET_ALL_FAILED" = false ] && [ "$RESET_STUCK" = false ] && [ ${#TASK_IDS[@]} -eq 0 ]; then
    log_error "Specify task IDs, --all-failed, or --stuck"
    echo "Run 'cw-reset --help' for usage."
    exit 1
fi

if ! discover_session; then
    log_error "No session with tasks found."
    log_info "Run '/cw-plan' first to create tasks."
    exit 1
fi

# =============================================================================
# Reset Logic
# =============================================================================

RESET_COUNT=0

reset_task_file() {
    local task_file="$1"
    [ -f "$task_file" ] || return

    # Reset status to pending, clear failure metadata
    jq '.status = "pending" |
        .metadata.failure_count = 0 |
        .metadata.last_failure = null |
        del(.owner)' "$task_file" > "${task_file}.tmp" && mv "${task_file}.tmp" "$task_file"

    RESET_COUNT=$((RESET_COUNT + 1))
}

if [ "$RESET_ALL_FAILED" = true ]; then
    log_info "Resetting all failed tasks..."

    for task_file in "$CW_TASKS_DIR"/*.json; do
        [ -f "$task_file" ] || continue

        failure_count=$(jq '.metadata.failure_count // 0' "$task_file" 2>/dev/null)
        status=$(jq -r '.status' "$task_file" 2>/dev/null)

        if [ "$failure_count" -gt 0 ] || { [ "$status" != "completed" ] && [ "$status" != "pending" ]; }; then
            task_id=$(jq -r '.metadata.task_id // .id' "$task_file" 2>/dev/null)
            log_info "  Resetting: $task_id ($status, failures: $failure_count)"
            reset_task_file "$task_file"
        fi
    done
fi

if [ "$RESET_STUCK" = true ]; then
    log_info "Resetting stuck in_progress tasks..."

    for task_file in "$CW_TASKS_DIR"/*.json; do
        [ -f "$task_file" ] || continue

        status=$(jq -r '.status' "$task_file" 2>/dev/null)
        if [ "$status" = "in_progress" ]; then
            task_id=$(jq -r '.metadata.task_id // .id' "$task_file" 2>/dev/null)
            log_info "  Resetting: $task_id (in_progress → pending)"
            reset_task_file "$task_file"
        fi
    done
fi

if [ ${#TASK_IDS[@]} -gt 0 ]; then
    log_info "Resetting specific tasks: ${TASK_IDS[*]}"

    for target_id in "${TASK_IDS[@]}"; do
        FOUND=false

        for task_file in "$CW_TASKS_DIR"/*.json; do
            [ -f "$task_file" ] || continue

            task_id=$(jq -r '.metadata.task_id // .id' "$task_file" 2>/dev/null)
            if [ "$task_id" = "$target_id" ]; then
                log_info "  Resetting: $task_id"
                reset_task_file "$task_file"
                FOUND=true
                break
            fi
        done

        if [ "$FOUND" = false ]; then
            log_warning "  Task not found: $target_id"
        fi
    done
fi

# =============================================================================
# Summary
# =============================================================================

if [ "$RESET_COUNT" -gt 0 ]; then
    log_success "Reset $RESET_COUNT task(s) to pending"
    print_task_status
else
    log_warning "No tasks were reset"
fi
