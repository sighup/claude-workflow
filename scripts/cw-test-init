#!/bin/bash
#
# cw-test-init - Test Scenario Generator
#
# Creates E2E test tasks from a spec or prompt via the cw-testing skill.
# Generates TEST-* prefixed tasks on the task board.
#
# Usage:
#   ./cw-test-init [OPTIONS]
#
# Options:
#   --prompt TEXT          Generate test scenarios from this description
#   --spec PATH           Generate test scenarios from this spec file
#   -m, --model MODEL     Claude model to use (default: sonnet)
#   -v, --verbose         Stream JSON output for real-time visibility
#   -h, --help            Show this help message
#
# If no options given, auto-discovers the most recent spec in docs/specs/.
#
# Exit Codes:
#   0  Success (test tasks created)
#   1  Test generation failed
#   4  Missing dependencies
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cw-common.sh"

# =============================================================================
# Argument Parsing
# =============================================================================

INPUT_MODE=""
INPUT_VALUE=""

show_help() {
    echo "Usage: cw-test-init [OPTIONS]"
    echo ""
    echo "Test scenario generator. Creates TEST-* tasks via cw-testing skill."
    echo ""
    echo "Options:"
    echo "  --prompt TEXT        Generate test scenarios from description"
    echo "  --spec PATH         Generate test scenarios from spec file"
    echo "  -m, --model MODEL   Claude model (default: $CW_MODEL)"
    echo "  -v, --verbose       Stream JSON output for real-time visibility"
    echo "  -h, --help          Show this help"
    echo ""
    echo "If no options given, auto-discovers the most recent spec in docs/specs/."
    echo ""
    echo "Exit Codes:"
    echo "  0  Success (test tasks created)"
    echo "  1  Test generation failed"
    echo "  4  Missing dependencies"
    echo ""
    echo "Examples:"
    echo "  cw-test-init --spec docs/specs/01-spec-auth/01-spec-auth.md"
    echo "  cw-test-init --prompt 'Test JWT authentication flows'"
    echo "  cw-test-init          # auto-discover latest spec"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --prompt) INPUT_MODE="prompt"; INPUT_VALUE="$2"; shift 2 ;;
        --spec) INPUT_MODE="spec"; INPUT_VALUE="$2"; shift 2 ;;
        -m|--model) CW_MODEL="$2"; shift 2 ;;
        -v|--verbose) CW_VERBOSE=true; shift ;;
        -h|--help) show_help; exit 0 ;;
        -*) log_error "Unknown option: $1"; show_help; exit 4 ;;
        *) log_error "Unexpected argument: $1"; show_help; exit 4 ;;
    esac
done

# =============================================================================
# Preflight Checks
# =============================================================================

check_jq || exit 4
check_claude || exit 4

print_banner "Claude Workflow - Test Init"

log_info "Model: $CW_MODEL"

# =============================================================================
# Resolve Input
# =============================================================================

if [ "$INPUT_MODE" = "spec" ]; then
    if ! resolve_spec_input "spec" "$INPUT_VALUE"; then
        exit 1
    fi
elif [ "$INPUT_MODE" = "prompt" ]; then
    if ! resolve_spec_input "prompt" "$INPUT_VALUE"; then
        exit 1
    fi
else
    log_info "Auto-discovering most recent spec..."
    if ! resolve_spec_input "auto"; then
        log_error "No spec found. Use --prompt or --spec to provide one."
        exit 1
    fi
fi

log_info "Input mode: $CW_SPEC_MODE"
log_info "Input value: $CW_SPEC_VALUE"

# =============================================================================
# Discover Session (for resuming context)
# =============================================================================

# Try to discover existing session so test tasks are added to the same board
discover_session 2>/dev/null || true

# =============================================================================
# Generate Test Scenarios
# =============================================================================

log_header "Generating Test Scenarios"

if [ "$CW_SPEC_MODE" = "prompt" ]; then
    TEST_PROMPT="Use the Skill tool to invoke 'cw-testing' with args 'init'.

Generate E2E test scenarios for the following:
$CW_SPEC_VALUE

This is running non-interactively, so DO NOT use AskUserQuestion — make reasonable decisions and proceed autonomously. Create TEST-* prefixed tasks on the task board covering critical paths, edge cases, and error scenarios."
else
    TEST_PROMPT="Use the Skill tool to invoke 'cw-testing' with args 'init'.

Generate E2E test scenarios from this specification: $CW_SPEC_VALUE

This is running non-interactively, so DO NOT use AskUserQuestion — make reasonable decisions and proceed autonomously. Create TEST-* prefixed tasks on the task board covering critical paths, edge cases, and error scenarios."
fi

if ! invoke_claude "$TEST_PROMPT" "$CW_MODEL"; then
    log_error "Test scenario generation failed"
    exit 1
fi

log_success "Test scenario generation completed"

# =============================================================================
# Summary
# =============================================================================

if discover_session 2>/dev/null; then
    log_header "Test Init Complete"
    log_info "Session: $CW_SESSION_ID"
    print_task_status
    show_task_list

    echo ""
    echo -e "${GREEN}Test tasks created.${NC}"
    echo "  Run tests: ./scripts/cw-test-loop"
else
    log_warning "Could not discover session. Check task board manually."
fi

exit 0
