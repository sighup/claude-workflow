#!/bin/bash
#
# cw-init - Spec + Plan Initializer
#
# Combines /cw-spec and /cw-plan into a single CLI invocation.
# Generates a specification from a prompt (or uses an existing spec),
# then creates a task graph — all non-interactively.
#
# Usage:
#   ./cw-init [OPTIONS]
#
# Options:
#   --prompt TEXT          Generate spec from this prompt, then plan tasks
#   --spec PATH           Use an existing spec file, skip to planning
#   -m, --model MODEL     Claude model to use (default: sonnet)
#   -v, --verbose         Stream JSON output for real-time visibility
#   -h, --help            Show this help message
#
# If no options given, auto-discovers the most recent spec in docs/specs/.
#
# Exit Codes:
#   0  Success (spec + plan created)
#   1  Spec generation failed
#   2  Plan generation failed
#   4  Missing dependencies
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/lib/cw-common.sh"

# =============================================================================
# Argument Parsing
# =============================================================================

INPUT_MODE=""
INPUT_VALUE=""

show_help() {
    echo "Usage: cw-init [OPTIONS]"
    echo ""
    echo "Spec + Plan initializer. Combines /cw-spec and /cw-plan."
    echo ""
    echo "Options:"
    echo "  --prompt TEXT        Generate spec from prompt, then plan tasks"
    echo "  --spec PATH         Use existing spec, skip to planning"
    echo "  -m, --model MODEL   Claude model (default: $CW_MODEL)"
    echo "  -v, --verbose       Stream JSON output for real-time visibility"
    echo "  -h, --help          Show this help"
    echo ""
    echo "If no options given, auto-discovers the most recent spec in docs/specs/."
    echo ""
    echo "Exit Codes:"
    echo "  0  Success (spec + plan created)"
    echo "  1  Spec generation failed"
    echo "  2  Plan generation failed"
    echo "  4  Missing dependencies"
    echo ""
    echo "Examples:"
    echo "  cw-init --prompt 'Build JWT authentication'"
    echo "  cw-init --spec docs/specs/01-spec-auth/01-spec-auth.md"
    echo "  cw-init                # auto-discover latest spec"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --prompt) INPUT_MODE="prompt"; INPUT_VALUE="$2"; shift 2 ;;
        --spec) INPUT_MODE="spec"; INPUT_VALUE="$2"; shift 2 ;;
        -m|--model) CW_MODEL="$2"; shift 2 ;;
        -v|--verbose) CW_VERBOSE=true; shift ;;
        -h|--help) show_help; exit 0 ;;
        -*) log_error "Unknown option: $1"; show_help; exit 4 ;;
        *) log_error "Unexpected argument: $1"; show_help; exit 4 ;;
    esac
done

# =============================================================================
# Preflight Checks
# =============================================================================

check_jq || exit 4
check_claude || exit 4

print_banner "Claude Workflow - Init (Spec + Plan)"

log_info "Model: $CW_MODEL"

# =============================================================================
# Phase 1: Spec Generation
# =============================================================================

if [ "$INPUT_MODE" = "spec" ]; then
    # Using existing spec — skip generation
    if [ ! -f "$INPUT_VALUE" ]; then
        log_error "Spec file not found: $INPUT_VALUE"
        exit 1
    fi
    log_info "Using existing spec: $INPUT_VALUE"
    SPEC_PATH="$INPUT_VALUE"

elif [ "$INPUT_MODE" = "prompt" ]; then
    # Generate spec from prompt
    log_header "Phase 1: Generating Spec"
    log_info "Prompt: $INPUT_VALUE"

    SPEC_PROMPT="Use the Skill tool to invoke 'cw-spec'.

Generate a specification for the following feature. This is running non-interactively, so DO NOT use AskUserQuestion — make reasonable decisions and proceed autonomously.

Feature description:
$INPUT_VALUE

Important: Generate the complete spec without asking questions. Use your best judgment for any decisions that would normally require user input. Write the spec to docs/specs/ following the standard naming convention."

    if ! invoke_claude "$SPEC_PROMPT" "$CW_MODEL"; then
        log_error "Spec generation failed"
        exit 1
    fi

    log_success "Spec generation completed"

    # Auto-discover the spec that was just created
    if ! resolve_spec_input "auto"; then
        log_error "Could not find generated spec file"
        exit 1
    fi
    SPEC_PATH="$CW_SPEC_VALUE"
else
    # Auto-discover mode — find the most recent spec
    log_info "Auto-discovering most recent spec..."
    if ! resolve_spec_input "auto"; then
        log_error "No spec found. Use --prompt or --spec to provide one."
        exit 1
    fi
    SPEC_PATH="$CW_SPEC_VALUE"
    log_info "Found spec: $SPEC_PATH"
fi

# =============================================================================
# Phase 2: Plan Generation
# =============================================================================

log_header "Phase 2: Generating Task Plan"
log_info "Spec: $SPEC_PATH"

PLAN_PROMPT="Use the Skill tool to invoke 'cw-plan'.

Create a task graph from this specification: $SPEC_PATH

This is running non-interactively, so DO NOT use AskUserQuestion — make reasonable decisions and proceed autonomously. Specifically:
- Skip the CLAUDE_CODE_TASK_LIST_ID check (Phase 0)
- Create parent tasks for each demoable unit
- Automatically generate sub-tasks (do not wait for approval)
- Set up all dependencies between tasks

Proceed through all phases without stopping for user input."

if ! invoke_claude "$PLAN_PROMPT" "$CW_MODEL"; then
    log_error "Plan generation failed"
    exit 2
fi

log_success "Plan generation completed"

# =============================================================================
# Summary
# =============================================================================

# Discover the session that was just created (by the plan invocation)
if discover_session; then
    log_header "Init Complete"
    log_info "Spec: $SPEC_PATH"
    log_info "Session: $CW_SESSION_ID"
    print_task_status
    show_task_list

    echo ""
    echo -e "${GREEN}Ready for execution.${NC}"
    echo "  Autonomous:   ./scripts/cw-loop"
    echo "  Parallel:     ./scripts/cw-loop -d"
    echo "  Interactive:  ./scripts/cw-loop-interactive"
    echo "  Full pipeline: ./scripts/cw-pipeline"
else
    log_warning "Could not discover session. Tasks may still have been created."
    log_info "Run 'cw-status' to check."
fi

exit 0
